{"title":"Depack Compile Preact Bootstrap Form","content":"<h1>Compilation With Depack</h1>\n\n<p>\n  The module was compiled with <em>Depack</em>: the website bundler that runs Google Closure Compiler. The command for creating the bundle is:\n</p>\n\n<pre><code class=\"json hljs\">{\n  <span class=\"hljs-attr\">\"depack\"</span>: <span class=\"hljs-string\">\"depack example/App.jsx -o splendid/js/main.js -I 2018 -a -H -p -w\"</span>\n}</code></pre>\n\nwhere the advanced compilation is set, as well as Preact's <span class=\"tm\">h</span> pragma added to the beginning of each file. <span class=\"tm\">-p</span> is for pretty printing, and <span class=\"tm\">-w</span> for no warnings. <em>Depack</em> then performs static-analysis on the entered files, and creates a temp directory where it transpiles JSX files.\n\n<img style=\"padding:2rem 0\" src=\"img/at.gif\" alt=\"Depack Preact Form Compilation\"/>\n\n<p class=\"SectionBreak\">\n  <a href=\"#top\" title=\"Back To Top\">\n    <img src=\"section-breaks/0.svg\" alt=\"Back To Top\" width=\"15px\">\n  </a>\n</p>\n\n<h2>Development Server</h2>\n\nThe development server is setup with the\n<a href=\"https://npmjs.com/package/@idio/frontend\" class=\"Badge\"><span class=\"name\">\n  @idio/<em>FrontEnd</em>\n</span><span class=\"version\">1.4.0</span></a>\nmiddleware that serves the source files as modules with JSX transpiled using <a href=\"https://npmjs.com/package/@a-la/jsx\" class=\"Badge\"><span class=\"name\">\n   @a-la/<em>JSX</em>\n </span><span class=\"version\">1.4.0</span></a>. This allows to change source code files and serve them as native modules that the modern browser understands.\n\n<pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> core <span class=\"token keyword\">from</span> <span class=\"token string\">'@idio/core'</span>\n<span class=\"token keyword\">import</span> render <span class=\"token keyword\">from</span> <span class=\"token string\">'preact-render-to-string'</span>\n\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> url <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">core</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    frontend<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> directory<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'example'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'src'</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">serve</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> <span class=\"token string\">'&lt;!doctype html>'</span> <span class=\"token operator\">+</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>html<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>head<span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span>link rel<span class=\"token operator\">=</span><span class=\"token string\">\"stylesheet\"</span> href<span class=\"token operator\">=</span><span class=\"token string\">\"https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css\"</span> integrity<span class=\"token operator\">=</span><span class=\"token string\">\"sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS\"</span> crossOrigin<span class=\"token operator\">=</span><span class=\"token string\">\"anonymous\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span>meta charset<span class=\"token operator\">=</span><span class=\"token string\">\"utf-8\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span>meta name<span class=\"token operator\">=</span><span class=\"token string\">\"viewport\"</span> content<span class=\"token operator\">=</span><span class=\"token string\">\"width=device-width, initial-scale=1, shrink-to-fit=no\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\n\n          <span class=\"token operator\">&lt;</span>title<span class=\"token operator\">></span>Form Example<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>title<span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span>style<span class=\"token operator\">></span>\n            <span class=\"token punctuation\">{</span><span class=\"token template-string\"><span class=\"token string\">`body {\n              background: #dfffdf;\n            }`</span></span><span class=\"token punctuation\">}</span>\n          <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>style<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>head<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>body id<span class=\"token operator\">=</span><span class=\"token string\">\"preact\"</span><span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span>script type<span class=\"token operator\">=</span><span class=\"token string\">\"module\"</span> src<span class=\"token operator\">=</span><span class=\"token string\">\"/example/App.jsx\"</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>body<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>html<span class=\"token operator\">></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'%s'</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre>\n\nThe server code itself is written in JSX thanks to the ÀLaMode's require hook. The JSX's <em>VNode</em> tree is then transformed into HTML with <span class=\"tm\">preact-render-to-string</span>.\n\n<pre><code class=\"js hljs\"><span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'alamode'</span>)()\n<span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">`../<span class=\"hljs-subst\">${process.argv[<span class=\"hljs-number\">2</span>]}</span>`</span>)</code></pre>\n\nThe example can be started with <span class=\"tm\">yarn example/</span> command:\n\n<pre><code class=\"sh hljs\">MacBook:form zavr$ yarn example/\nyarn run v1.13.0\n$ yarn e example/example\n$ node example example/example\nhttp://localhost:5000</code></pre>\n<p class=\"SectionBreak\">\n  <a href=\"#top\" title=\"Back To Top\">\n    <img src=\"section-breaks/1.svg\" alt=\"Back To Top\" width=\"15px\">\n  </a>\n</p>\n\n<h2>Main And Module</h2>\n\nBecause the <em>FrontEnd</em> middleware serves data from the <span class=\"tm\">module</span> directory, and <em>Depack</em> compiles files from there as well, the package exports the <span class=\"tm\">module</span> field in its package.json file that points to the source code built with ÀLaMode to convert <span class=\"tm\">&lt;jsx&gt;&lt;/jsx&gt;</span> into Preact's pragma executions: <span class=\"tm\">h(&apos;jsx&apos;, {})</span>. The module containts <span class=\"tm\">import</span> and <span class=\"tm\">export</span> statements, therefore it needs to be used by the bundler and development middleware that can serve it. <em>Depack</em> passes all modules to the Google Closure Compiler and it is the preferred way to build for the modern web, since the <span class=\"tm\">require</span> call should become obsolete. The following example shows what code is exported in the <span class=\"tm\">module</span> field:\n\n<pre><code class=\"js hljs\"><span class=\"hljs-keyword\">import</span> { h } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'preact'</span>\n<span class=\"hljs-keyword\">import</span> { Component } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'preact'</span>\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Form</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Component</span> </span>{\n  <span class=\"hljs-keyword\">constructor</span>() {\n    <span class=\"hljs-keyword\">super</span>()\n    <span class=\"hljs-keyword\">this</span>.state = {\n      <span class=\"hljs-attr\">values</span>: {},\n    }\n    <span class=\"hljs-comment\">/**\n     * @type {FormProps}\n     */</span>\n    <span class=\"hljs-keyword\">this</span>.props = <span class=\"hljs-keyword\">this</span>.props\n  }\n  getChildContext() {\n    <span class=\"hljs-keyword\">return</span> {\n      <span class=\"hljs-attr\">values</span>: <span class=\"hljs-keyword\">this</span>.state.values,\n      <span class=\"hljs-attr\">onChange</span>: <span class=\"hljs-keyword\">this</span>.onChange.bind(<span class=\"hljs-keyword\">this</span>),\n    }\n  }\n  onChange(name, value) {\n    <span class=\"hljs-keyword\">this</span>.setState({\n      <span class=\"hljs-attr\">values</span>: {\n        ...this.state.values,\n        [name]: value,\n      },\n    })\n    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.props.onChange)\n      <span class=\"hljs-keyword\">this</span>.props.onChange(<span class=\"hljs-keyword\">this</span>.state.values)\n  }\n  render({ children, ...props }) {\n    <span class=\"hljs-keyword\">return</span>     h(<span class=\"hljs-string\">'form'</span>,{...props},\n      children,\n    )\n  }\n}\n\n<span class=\"hljs-comment\">/**\n * The div with `form-group` class to hold the label, input, help and validation message.\n */</span>\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">FormGroup</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Component</span> </span>{\n  <span class=\"hljs-keyword\">constructor</span>() {\n    <span class=\"hljs-keyword\">super</span>()\n    <span class=\"hljs-keyword\">this</span>.id = <span class=\"hljs-string\">`i<span class=\"hljs-subst\">${<span class=\"hljs-built_in\">Math</span>.floor(<span class=\"hljs-built_in\">Math</span>.random() * <span class=\"hljs-number\">100000</span>)}</span>`</span>\n    <span class=\"hljs-keyword\">this</span>.hid = <span class=\"hljs-string\">`h<span class=\"hljs-subst\">${<span class=\"hljs-keyword\">this</span>.id}</span>`</span>\n    <span class=\"hljs-comment\">/**\n     * @type {FormGroupProps}\n     */</span>\n    <span class=\"hljs-keyword\">this</span>.props = <span class=\"hljs-keyword\">this</span>.props\n  }\n  getChildContext() {\n    <span class=\"hljs-keyword\">return</span> {\n      <span class=\"hljs-attr\">id</span>: <span class=\"hljs-keyword\">this</span>.id,\n      <span class=\"hljs-attr\">hid</span>: <span class=\"hljs-keyword\">this</span>.hid,\n    }\n  }\n  render() {\n    <span class=\"hljs-keyword\">const</span> { children, label, help } = <span class=\"hljs-keyword\">this</span>.props\n    <span class=\"hljs-keyword\">return</span> h(<span class=\"hljs-string\">'div'</span>,{<span class=\"hljs-string\">'className'</span>:<span class=\"hljs-string\">\"form-group\"</span>},\n      label &amp;&amp; h(<span class=\"hljs-string\">'label'</span>,{<span class=\"hljs-string\">'htmlFor'</span>:<span class=\"hljs-keyword\">this</span>.id},label),\n      children,\n      help &amp;&amp; h(<span class=\"hljs-string\">'small'</span>,{<span class=\"hljs-string\">'id'</span>:<span class=\"hljs-keyword\">this</span>.hid,<span class=\"hljs-string\">'dangerouslySetInnerHTML'</span>:{ <span class=\"hljs-attr\">__html</span>: help },<span class=\"hljs-string\">'className'</span>:<span class=\"hljs-string\">\"form-text text-muted\"</span>}),\n    )\n  }\n}\n\n<span class=\"hljs-keyword\">export</span> { <span class=\"hljs-keyword\">default</span> <span class=\"hljs-keyword\">as</span> Select } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./Select'</span>\n<span class=\"hljs-keyword\">export</span> { <span class=\"hljs-keyword\">default</span> <span class=\"hljs-keyword\">as</span> TextArea } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./TextArea'</span>\n<span class=\"hljs-keyword\">export</span> { <span class=\"hljs-keyword\">default</span> <span class=\"hljs-keyword\">as</span> Input } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'./Input'</span>\n\n<span class=\"hljs-comment\">/* documentary types/index.xml */</span>\n<span class=\"hljs-comment\">/**\n * @typedef {Object} FormProps Options for the Form component.\n * @prop {function} [onChange] The callback to call when a change is made to any of the inputs inside of the form.\n *\n * @typedef {Object} FormGroupProps\n * @prop {string} [label] The label to display for the group.\n * @prop {string} [help] The help text to show in `&lt;small className=\"form-text text-muted\"&gt;{help}&lt;/small&gt;`\n */</span>\n</code></pre>\n\nThe program as modules can be viewed on the following page. <a href=\"/%E2%88%82epack-modules.html\">Modules Demo</a>. The aim was to discover the use case for building JSX files into JS for serving as modules on CDNs like GitHub pages where the addition of <span class=\"tm\">.jsx</span> extension is required for serving <span class=\"tm\">&lt;script type=&quot;module&quot;&gt;&lt;/script&gt;</span>.\n<!-- The program is built with simple JSX parser. -->","file":"2-depack"}